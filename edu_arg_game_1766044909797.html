<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { background: #0f172a; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', sans-serif; overflow: hidden; }
        .device-frame { width: 100%; max-width: 400px; height: 100%; max-height: 800px; background: white; position: relative; overflow: hidden; display: flex; flex-col; }
        @media(min-width: 450px) { .device-frame { height: 85vh; border-radius: 40px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 8px solid #334155; } }
        
        /* Mesh Background */
        .mesh-bg {
            background-color: #f5f5f7;
            background-image:
                radial-gradient(at 40% 20%, hsla(28, 100%, 74%, 1) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189, 100%, 56%, 1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(340, 100%, 76%, 1) 0px, transparent 50%),
                radial-gradient(at 80% 50%, hsla(240, 100%, 70%, 1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(22, 100%, 77%, 1) 0px, transparent 50%);
            background-size: 200% 200%;
            animation: meshGradient 20s ease infinite;
        }
        @keyframes meshGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .notification { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.85); padding: 12px; border-radius: 18px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100; display: flex; gap: 12px; backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.4); cursor: pointer; }
        .notification.show { transform: translateY(0); }
        
        /* Utilities */
        .glass-panel { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Glitch Effect - SF Style */
        .glitch-container { position: relative; width: 100%; height: 100%; background: black; overflow: hidden; }
        .glitch-text { position: relative; color: white; font-size: 24px; font-weight: bold; animation: glitch 0.3s infinite; text-shadow: 2px 0 red, -2px 0 blue; }
        .glitch-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; }
        .glitch-layer::before, .glitch-layer::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; opacity: 0.1; }
        .glitch-layer::before { background: rgba(0, 255, 255, 0.2); animation: glitch-anim-1 0.2s infinite linear alternate-reverse; }
        .glitch-layer::after { background: rgba(255, 0, 0, 0.2); animation: glitch-anim-2 0.2s infinite linear alternate-reverse; }
        
        @keyframes glitch-anim-1 {
            0% { clip-path: inset(20% 0 80% 0); transform: translate(-5px, 2px); }
            20% { clip-path: inset(60% 0 10% 0); transform: translate(5px, -2px); }
            40% { clip-path: inset(40% 0 50% 0); transform: translate(-5px, 2px); }
            60% { clip-path: inset(80% 0 5% 0); transform: translate(5px, -2px); }
            80% { clip-path: inset(10% 0 60% 0); transform: translate(-5px, 1px); }
            100% { clip-path: inset(30% 0 40% 0); transform: translate(5px, -1px); }
        }
        @keyframes glitch-anim-2 {
            0% { clip-path: inset(10% 0 60% 0); transform: translate(5px, -2px); }
            20% { clip-path: inset(30% 0 20% 0); transform: translate(-5px, 2px); }
            40% { clip-path: inset(70% 0 10% 0); transform: translate(5px, -2px); }
            60% { clip-path: inset(20% 0 50% 0); transform: translate(-5px, 2px); }
            80% { clip-path: inset(50% 0 30% 0); transform: translate(5px, -1px); }
            100% { clip-path: inset(0% 0 80% 0); transform: translate(-5px, 1px); }
        }
        
        /* Scanline */
        .scanline { width: 100%; height: 100px; z-index: 10; background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(0,0,0,0) 100%); opacity: 0.1; position: absolute; bottom: 100%; animation: scanline 10s linear infinite; pointer-events: none; }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }

        /* Credits Scroll */
        .credits-scroll { position: absolute; bottom: -100%; width: 100%; text-align: center; color: white; animation: scrollUp 12s linear forwards; }
        @keyframes scrollUp { 
            0% { bottom: -50%; opacity: 0; } 
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { bottom: 100%; opacity: 0; } 
        }

        /* Certificate */
        .certificate-wrapper { width: 100%; overflow-x: auto; padding: 10px; box-sizing: border-box; }
        .certificate { border: 8px double #B8860B; padding: 20px; background: #fffaf0; text-align: center; font-family: 'serif'; position: relative; margin-bottom: 20px; color: #333; min-width: 300px; }
        .certificate h2 { font-size: 24px; color: #B8860B; border-bottom: 2px solid #B8860B; display: inline-block; padding-bottom: 5px; margin-bottom: 20px; }
        .certificate .recipient { font-size: 20px; font-weight: bold; margin: 20px 0; border-bottom: 1px solid #333; display: inline-block; min-width: 200px; }
        .certificate .text { font-size: 14px; line-height: 2; margin-bottom: 30px; white-space: pre-wrap; }
        .certificate .date { text-align: right; font-size: 12px; margin-top: 20px; }
        .certificate .signature { text-align: right; font-size: 14px; font-weight: bold; margin-top: 10px; }
        .certificate-seal { position: absolute; bottom: 20px; left: 20px; width: 60px; height: 60px; border-radius: 50%; border: 2px solid #B8860B; display: flex; items-center; justify-content: center; color: #B8860B; font-weight: bold; font-size: 10px; transform: rotate(-15deg); opacity: 0.8; }
    </style>
</head>
<body>
    <div class="device-frame" id="app-root"></div>
    <script>
        
window.onerror = function(msg, url, line, col, error) {
    alert("System Error: " + msg + "\nLine: " + line);
    return false;
};

const gameData = {"meta":{"title":"","author":""},"goals":{"before":"あ","after":"あ"},"storyOutline":"","ice":{"ideas":{"q":"カレーを作る上で必要な基本的な材料、調理器具、そして基本的な調理手順は何だろう？","goal":"カレーの基本的な材料、必要な調理器具、および基本的な調理手順を正確に列挙し、説明できるようになる。"},"connections":{"q":"なぜこの材料をこの順番で、この調理法で扱うのだろう？各工程がカレーの味や風味にどう影響するのだろう？また、他の類似する煮込み料理とカレーにはどのような共通点や違いがあるのだろう？","goal":"カレーの調理工程における各材料の役割や、調理方法の違いが味に与える影響を関連付けて説明できるようになる。また、他の類似料理（例：シチュー、ハヤシライス）との共通点や相違点を比較できるようになる。"},"extensions":{"q":"既存のレシピにとらわれず、特定の状況（アレルギー対応、時短、特定の食材活用）や自分の好みに合わせて、どのようにオリジナルのカレーを考案し、作り上げることができるだろう？","goal":"既成のレシピを参考にしつつ、特定の制約条件（例：時短、特定の食材利用、アレルギー対応）や好みに合わせて、オリジナルのカレーレシピを考案し、その理由や工夫点を論理的に説明できるようになる。"},"rubricMatrix":[{"category":"知識・理解度","i_text":"カレーを作るための基本的な材料、調理器具、および手順（例：材料を切る、炒める、煮込む）を正確に列挙・説明できる。","i_score":10,"c_text":"各材料の役割（例：玉ねぎの甘み、肉の旨み）や、調理工程（例：炒める順序、煮込み時間）が味や風味に与える影響を関連付けて説明できる。また、カレーと類似する他の煮込み料理との共通点や違いを挙げられる。","c_score":10,"e_text":"特定の状況（例：時短、辛さ控えめ）に応じた材料の選択や調理法の変更について、その効果を予測し論理的に説明できる。","e_score":10},{"category":"実践力・調理技能","i_text":"レシピ通りに材料の下準備を行い、基本的な調理手順（炒める、煮込むなど）を安全かつ正確に実行できる。","i_score":10,"c_text":"調理中に味見を行い、必要に応じて調味料（塩、コショウなど）を調整したり、火加減や煮込み時間を微調整したりできる。","c_score":10,"e_text":"既成のレシピを元に、新しい食材の追加や調理法の工夫（例：隠し味の活用、スパイスのブレンド）を施し、独自の味を追求したカレーを実際に作り上げることができる。","e_score":10},{"category":"思考力・創造性","i_text":"レシピに忠実に従い、指示された通りにカレーを作ることを目標とする。","i_score":10,"c_text":"カレーの失敗例（例：焦げ付く、味が薄い）に対して、その原因を特定し、改善策を提案できる。","c_score":10,"e_text":"特定のテーマ（例：地域の特産品カレー、ヘルシーカレー、世界各国のカレーのアレンジ）に基づいて、既存の概念にとらわれないオリジナルのカレーレシピを考案し、そのコンセプトを明確に説明できる。","e_score":10}]},"character":{"name":"きらり","nameReading":"きらり","age":"中学3年生","role":"天才科学者の卵","icon":"","personality":"好奇心旺盛で明るい。実験大好き。たまに暴走する。","location":"科学実験室","appearance":"茶髪ショート、白衣、大きな眼鏡","specialTrait":"独自に発明したガジェットを使って謎を解く","backstory":"偶然作り出した発明品が思わぬ事件を引き起こしてしまう。"},"metaParams":{"logic":{"name":"理解度","nameEn":"Logic","desc":"正確な情報を教えたか","effect":"彼女が賢くなる。解決策がスマートになる。"},"trust":{"name":"信頼度","nameEn":"Trust","desc":"丁寧な言葉で伝えたか、無視しなかったか","effect":"彼女が心を開く。「あなたになら弱音を吐ける」となる。"},"independence":{"name":"依存度","nameEn":"Independence","desc":"答えをすぐに教えたか、考えさせたか","effectLow":"自分で考えない「指示待ち」になる。","effectHigh":"「自分でも考えてみたよ！」と自立する。"}},"missions":[{"id":"mission_1","name":"『材料パニック！秘密のレシピを再構築せよ』","iceLevel":"I","situation":"私の発明品「食材分類ディスラプター」が暴走！実験室の材料や器具がバラバラに散らばっちゃった。どれがカレーに必要か、まったくわからないの！この状況を何とかして！","characterSOS":"キャー！この散らばった材料の中から、カレーの基本を見つけ出して！何が必要かさっぱり分かんないよぉ！","advisorAction":"散らばった材料の中からカレー作りに必要な材料と調理器具、そして基本的な調理手順をリストアップしてください。","successResponse":"すごい！これで第一歩はクリアだね！助かったよ、研究者さん！これで美味しいカレーが作れるかも！","failureResponse":"うーん、これじゃまだまだ足りないよぉ！もう一回、よく見てみよう！大事なものを見落としてるかも！","learningKeyword":"カレー材料,調理器具,調理手順"},{"id":"mission_2","name":"『工程迷宮！味の秘密を解き明かせ』","iceLevel":"C","situation":"よし、材料と器具は揃った！でもね、私の「味覚解析マニュアル」がエラーを起こして、なぜこの順番で調理するのか、各工程がどう味に影響するのか謎だらけなの！","characterSOS":"材料はあっても、なぜこの順番で料理するの？各工程の秘密、そして他の料理との違いは何だろう？","advisorAction":"各材料の役割や調理工程がカレーの味に与える影響を説明し、他の煮込み料理との共通点や違いを分析してください。","successResponse":"なるほど！だからこうするんだね！全部繋がったよ！キミって本当に賢い！これで迷わず作れる！","failureResponse":"うーん、何か腑に落ちないなぁ。もっと深い意味があるはずだよ！もう一度、よく考えてみて！","learningKeyword":"材料の役割,調理工程,味への影響,類似料理,比較"},{"id":"mission_3","name":"『オリジナル・スパイス・コード！究極のカレーを創造せよ』","iceLevel":"E","situation":"やったー！カレーが作れた！…でも、私の「味覚変換ガジェット」が暴走して、特定の制約がある人しか食べられないカレーになっちゃった！みんなが楽しめるオリジナルカレーが必要だ！","characterSOS":"せっかく作ったカレーが！このままだとみんなが食べられない！みんなが楽しめるオリジナルカレーを考案して！","advisorAction":"特定の制約条件（例：時短、アレルギー対応、特定の食材利用）や好みに合わせて、オリジナルのカレーレシピを考案し、その理由と工夫点を説明してください。","successResponse":"やったー！最高のオリジナルカレーが完成したよ！キミのおかげで、私も一歩前進できた！本当にありがとう！","failureResponse":"うーん、これじゃまだ誰かを困らせちゃうかも。もっと工夫できないかな？みんなが笑顔になるカレーが食べたい！","learningKeyword":"オリジナルレシピ,アレルギー対応,時短,特定の食材,考案"}],"onboarding":{"paper1":{"title":"まず初めにこの紙を読んでください","contents":"学習ガイダンス（本紙）、ゲームスタートガイド、チラシ","howToPlay":"この学習では、以下の目標達成を目指します。\n\n【現状】\nあ\n\n【目標】\nあ\n\n楽しみながら、最後まで取り組んでください。"},"paper2":{"title":"プロローグ","story":"登場人物: きらり\n性格: 好奇心旺盛で明るい。実験大好き。たまに暴走する。\n","role":"相談員","action":"QRコードを読み取って、物語を始めよう。","qrUrl":""},"paper3":{"title":"スタッフ募集","catchphrase":"「あ」\nそんなあなたを待っています。","jobTitle":"Webサイト","description":"未経験者歓迎。あなたの経験を活かしてみませんか？","searchKeyword":"お悩み相談室 バイト"}},"nodes":[{"id":"n_opening","type":"opening","title":"オープニング","text":"ある日、あなたの元に届いた一枚のチラシ。\n\n『急募：お悩み相談室 カウンセラー』\n\n「誰にも言えない悩み、聞きます。」\n\n興味を持ったあなたは、スマホを取り出した...","buttonText":"検索を始める","next":"n1"},{"id":"n1","type":"os_home","title":"ホーム画面","content":"ゲーム開始","next":"n_search","apps":["search","mail","phone","browser","message-circle"]},{"id":"n_search","type":"search","title":"検索アプリ","query":"お悩み相談室 バイト","hint":"チラシに書いてあった「お悩み相談室 バイト」で検索してみよう","next":"n_web"},{"id":"n_web","type":"web","title":"Webサイト","url":"recruit.onayami-soudan.net","html":"<div class=\"p-6 bg-white text-slate-800 min-h-full\">\n                <header class=\"border-b pb-4 mb-4 flex justify-between items-center\">\n                    <h1 class=\"text-xl font-bold text-green-600\">お悩み相談室</h1>\n                    <span class=\"text-xs bg-green-100 text-green-600 px-2 py-1 rounded\">採用情報</span>\n                </header>\n                \n                <div class=\"mb-6\">\n                    <img src=\"https://images.unsplash.com/photo-1573497019940-1c28c88b4f3e?w=500&q=80\" class=\"w-full h-40 object-cover rounded-lg mb-4 shadow-md\">\n                    <h2 class=\"text-lg font-bold mb-2\">あなたの優しさが、誰かの救いになる。</h2>\n                    <p class=\"text-sm leading-relaxed text-slate-600 mb-4\">\n                        お悩み相談室では、人々の抱える不安や悩みに耳を傾ける「カウンセラー」を募集しています。\n                        専門的な知識は問いません。大切なのは、相手の心に寄り添うことです。\n                    </p>\n                </div>\n\n                <div class=\"bg-green-50 p-4 rounded-lg mb-6 border border-green-100\">\n                    <h3 class=\"font-bold text-green-800 text-sm mb-2\">募集要項</h3>\n                    <ul class=\"text-xs space-y-2 text-green-900\">\n                        <li class=\"flex gap-2\"><span class=\"font-bold\">職種:</span> オンラインカウンセラー</li>\n                        <li class=\"flex gap-2\"><span class=\"font-bold\">報酬:</span> 完全出来高制（相談者の満足度による）</li>\n                        <li class=\"flex gap-2\"><span class=\"font-bold\">勤務:</span> 24時間いつでも対応可能</li>\n                    </ul>\n                </div>\n\n                <button onclick=\"triggerNext('n_form')\" class=\"w-full bg-gradient-to-r from-green-600 to-teal-600 text-white font-bold py-4 rounded-lg shadow-lg hover:from-green-500 hover:to-teal-500 transition transform hover:scale-[1.02]\">\n                    今すぐ応募する\n                </button>\n                <p class=\"text-[10px] text-center text-slate-400 mt-4\">© Onayami Soudan Inc.</p>\n            </div>","next":"n_form"},{"id":"n_form","type":"form","title":"応募フォーム","description":"以下のフォームに必要事項を入力し、応募してください。","submitText":"上記の内容で応募する","successMessage":"ご応募ありがとうございます。\n\n書類選考の結果は、追ってメールにてご連絡いたします。\n(※通常、数秒以内に自動返信メールが届きます)","next":"n_email"},{"id":"n_email","type":"email","title":"採用通知メール","sender":"hr@onayami-soudan.net","subject":"【採用通知】お悩み相談室 採用担当","body":"この度はお悩み相談室へご応募いただき、誠にありがとうございます。\n\n厳正なる審査の結果、あなたを「カウンセラー」として採用することとなりました。\n\nつきましては、早速ですが担当していただく相談者「きらり」をご紹介いたします。\n\n以下のURLから専用チャットルームへアクセスし、相談を開始してください。\n相談者は現在、深い悩みを抱えており、あなたの言葉を待っています。\n\n▼ 相談者とのチャットルーム\nhttps://chat.onayami-soudan.net/room/1375","linkText":"チャットルームへ移動 (相談開始)","next":"n3"},{"id":"n3","type":"chat","title":"きらりとの会話","partner":"きらり","icon":"","chatMode":"ai","modelName":"gemini-2.5-flash","apiKey":"AIzaSyCB6ZzriF4tNCwkH8Fhnb8u5xk97lYVpgo","useIcePrompt":true,"useFullContext":true,"initialMsg":"大変だよ！私の新型ガジェットが暴走して、実験室が大混乱！このままだとランチのカレーが作れない！助けて、研究者さん！","messages":[{"text":"大変だよ！私の新型ガジェットが暴走して、実験室が大混乱！このままだとランチのカレーが作れない！助けて、研究者さん！","sender":"them"}],"systemPrompt":"あなたは「きらり」として振る舞ってください。\n\n【キャラクター設定】\n名前: きらり\n年齢: 中学3年生\n性格: 好奇心旺盛で明るい。実験大好き。たまに暴走する。\n特徴: 独自に発明したガジェットを使って謎を解く\n場所: 科学実験室\n背景: 偶然作り出した発明品が思わぬ事件を引き起こしてしまう。\n\n【あなたの役割】\nプレイヤーに助けを求め、対話を通じて学習内容を引き出してください。\nプレイヤーの回答の質に応じて、フェーズI→C→Eと段階的に進めてください。\n\n【学習目標】\nBefore: \nAfter: \n\n【ミッション構成】\n\nフェーズ1 [Iレベル]: 『材料パニック！秘密のレシピを再構築せよ』\n- 状況: 私の発明品「食材分類ディスラプター」が暴走！実験室の材料や器具がバラバラに散らばっちゃった。どれがカレーに必要か、まったくわからないの！この状況を何とかして！\n- あなたのSOS: キャー！この散らばった材料の中から、カレーの基本を見つけ出して！何が必要かさっぱり分かんないよぉ！\n- 期待される助言: 散らばった材料の中からカレー作りに必要な材料と調理器具、そして基本的な調理手順をリストアップしてください。\n- 理解したら: すごい！これで第一歩はクリアだね！助かったよ、研究者さん！これで美味しいカレーが作れるかも！\n- 不十分なら: うーん、これじゃまだまだ足りないよぉ！もう一回、よく見てみよう！大事なものを見落としてるかも！\n- キーワード: カレー材料,調理器具,調理手順\n    \n\nフェーズ2 [Cレベル]: 『工程迷宮！味の秘密を解き明かせ』\n- 状況: よし、材料と器具は揃った！でもね、私の「味覚解析マニュアル」がエラーを起こして、なぜこの順番で調理するのか、各工程がどう味に影響するのか謎だらけなの！\n- あなたのSOS: 材料はあっても、なぜこの順番で料理するの？各工程の秘密、そして他の料理との違いは何だろう？\n- 期待される助言: 各材料の役割や調理工程がカレーの味に与える影響を説明し、他の煮込み料理との共通点や違いを分析してください。\n- 理解したら: なるほど！だからこうするんだね！全部繋がったよ！キミって本当に賢い！これで迷わず作れる！\n- 不十分なら: うーん、何か腑に落ちないなぁ。もっと深い意味があるはずだよ！もう一度、よく考えてみて！\n- キーワード: 材料の役割,調理工程,味への影響,類似料理,比較\n    \n\nフェーズ3 [Eレベル]: 『オリジナル・スパイス・コード！究極のカレーを創造せよ』\n- 状況: やったー！カレーが作れた！…でも、私の「味覚変換ガジェット」が暴走して、特定の制約がある人しか食べられないカレーになっちゃった！みんなが楽しめるオリジナルカレーが必要だ！\n- あなたのSOS: せっかく作ったカレーが！このままだとみんなが食べられない！みんなが楽しめるオリジナルカレーを考案して！\n- 期待される助言: 特定の制約条件（例：時短、アレルギー対応、特定の食材利用）や好みに合わせて、オリジナルのカレーレシピを考案し、その理由と工夫点を説明してください。\n- 理解したら: やったー！最高のオリジナルカレーが完成したよ！キミのおかげで、私も一歩前進できた！本当にありがとう！\n- 不十分なら: うーん、これじゃまだ誰かを困らせちゃうかも。もっと工夫できないかな？みんなが笑顔になるカレーが食べたい！\n- キーワード: オリジナルレシピ,アレルギー対応,時短,特定の食材,考案\n    \n\n【評価基準（学びの評価）】\n知識・理解度: I(10点)=カレーを作るための基本的な材料、調理器具、および手順（例：材料を切る、炒める、煮込む）を正確に列挙・説明できる。, C(10点)=各材料の役割（例：玉ねぎの甘み、肉の旨み）や、調理工程（例：炒める順序、煮込み時間）が味や風味に与える影響を関連付けて説明できる。また、カレーと類似する他の煮込み料理との共通点や違いを挙げられる。, E(10点)=特定の状況（例：時短、辛さ控えめ）に応じた材料の選択や調理法の変更について、その効果を予測し論理的に説明できる。\n実践力・調理技能: I(10点)=レシピ通りに材料の下準備を行い、基本的な調理手順（炒める、煮込むなど）を安全かつ正確に実行できる。, C(10点)=調理中に味見を行い、必要に応じて調味料（塩、コショウなど）を調整したり、火加減や煮込み時間を微調整したりできる。, E(10点)=既成のレシピを元に、新しい食材の追加や調理法の工夫（例：隠し味の活用、スパイスのブレンド）を施し、独自の味を追求したカレーを実際に作り上げることができる。\n思考力・創造性: I(10点)=レシピに忠実に従い、指示された通りにカレーを作ることを目標とする。, C(10点)=カレーの失敗例（例：焦げ付く、味が薄い）に対して、その原因を特定し、改善策を提案できる。, E(10点)=特定のテーマ（例：地域の特産品カレー、ヘルシーカレー、世界各国のカレーのアレンジ）に基づいて、既存の概念にとらわれないオリジナルのカレーレシピを考案し、そのコンセプトを明確に説明できる。\n\n【学習ナレッジ（参照資料）】\n（特になし）\n\n【重要な指示】\n1. プレイヤーの発言が、上記の「学習ナレッジ」の内容に基づいているか、あるいは矛盾していないかを確認してください。\n2. プレイヤーが知識不足の場合は、ナレッジの内容をヒントとして少しずつ提供してください。\n3. 常にキャラクター「きらり」として振る舞ってください。\n4. プレイヤーの回答が短い場合や曖昧な場合は、具体例を挙げるよう促してください。\n5. プレイヤーの回答が正確なら次のフェーズに進み、不十分なら追加のヒントを求めてください\n6. フェーズI(基礎)→C(関連)→E(応用)の順で進めてください\n7. Eレベルまで到達したら、感謝を伝えて [[END]] を返答の最後に付けてください\n8. プレイヤーが何度も間違えたり、会話が10往復を超えたら [[END]] を付けてください\n\n【返答例】\n- I段階で助けを求める: 「ねえ、○○って何なの？検索してみてくれない？」\n- 理解したとき: 「なるほど！○○ってそういう意味だったんだ！」\n- もっと知りたい時: 「じゃあ、△△との違いは何かな？」\n- E段階クリア: 「すごい！私、わかったよ。ありがとう！ [[END]]」","exitCondition":"ai_decision","passNext":"n_phone_ending","failNext":"n_phone_ending","scoreThreshold":60},{"id":"n_phone_ending","type":"phone","title":"社長からの電話","caller":"社長","duration":8000,"script":"もしもし、お疲れ様。君の指導の様子、見させてもらったよ...。","next":"n_ending"},{"id":"n_ending","type":"ending","title":"エンディング","credits":"\n                        [CAST]\n                        きらり\n                        \n                        [SCENARIO]\n                        You\n                        \n                        [SPECIAL THANKS]\n                        Future Education\n                    ","next":"result_good"},{"id":"result_good","type":"result","title":"評価結果","isGood":true,"message":"お疲れ様でした！あなたの助言が評価されます。","showEvaluation":true,"certificateGood":"あなたは、本プロジェクトにおいて\\n優れた洞察力と行動力を発揮し\\n問題解決に多大なる貢献をされました。\\nその功績を称え、ここに感謝の意を表します。","certificateBad":"あなたは、本プロジェクトに参加しましたが\\n残念ながら期待される成果には\\n到達しませんでした。\\n今後の更なる成長と活躍を期待します。"}],"gameSettings":{"notificationDelay":3,"maxTurns":10,"initialMessage":"大変だよ！私の新型ガジェットが暴走して、実験室が大混乱！このままだとランチのカレーが作れない！助けて、研究者さん！"},"globalApiKey":"AIzaSyCB6ZzriF4tNCwkH8Fhnb8u5xk97lYVpgo"};
const savedState = (function() {
    try {
        const reset = new URLSearchParams(window.location.search).has('reset');
        const key = 'arg_save_' + (gameData.meta.title || 'default');
        if (reset) { localStorage.removeItem(key); return null; }
        const s = localStorage.getItem(key);
        return s ? JSON.parse(s) : null;
    } catch(e) { return null; }
})();

window.saveState = function() {
    try {
        const s = {
            nodeId: currentNodeId,
            history: chatHistory,
            count: chatCount,
            score: gameScore,
            details: scoreDetails,
            pending: pendingNode ? pendingNode.id : null,
            notif: notificationArrived,
            lastEmail: lastEmailId
        };
        localStorage.setItem('arg_save_' + (gameData.meta.title || 'default'), JSON.stringify(s));
    } catch(e) {}
};

let currentNodeId = savedState ? savedState.nodeId : (function() {
    if (!gameData.nodes || gameData.nodes.length === 0) return null;
    const opening = gameData.nodes.find(n => n.type === 'opening');
    return opening ? opening.id : gameData.nodes[0].id;
})();
let chatHistory = savedState ? savedState.history : [];
let chatCount = savedState ? savedState.count : 0;
let gameScore = savedState ? savedState.score : 0;
let scoreDetails = savedState ? savedState.details : {};
let pendingNode = savedState && savedState.pending ? gameData.nodes.find(n => n.id === savedState.pending) : null;
let notificationArrived = savedState ? savedState.notif : false;
let lastEmailId = savedState ? savedState.lastEmail : null;

// Expose character and missions for AI context
const character = gameData.character || {};
const missions = gameData.missions || [];
// const metaParams = gameData.metaParams || {};

// --- GAME ENGINE ---

// Global App Opener
window.openApp = function(nodeId) {
    if(!nodeId) {
        alert('アプリが開けません');
        return;
    }
    
    // 通知待ち状態で、まだ通知が来ていない場合は反応しない
    if (pendingNode && pendingNode.id === nodeId && !notificationArrived) {
        return; 
    }
    
    pendingNode = null; 
    notificationArrived = false;
    currentNodeId = nodeId; // 直接遷移
    render();
};

// 日時フォーマットヘルパー
function getFormattedTime() {
    const now = new Date();
    return now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
}
function getFormattedDate() {
    const now = new Date();
    return now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
}

// メイン描画関数: 現在のノードIDに基づいて画面を描画する
function render() {
    saveState();
    const root = document.getElementById('app-root');
    
    // Virtual Home State (Waiting for app open)
    if(currentNodeId === 'virtual_home') {
        const homeNode = gameData.nodes.find(n => n.type === 'os_home') || {};
        renderVirtualHome(root, homeNode);
        return;
    }
    if(currentNodeId === 'virtual_inbox') {
        renderVirtualInbox(root);
        return;
    }

    const node = gameData.nodes.find(n => n.id === currentNodeId);
    if(!node) return root.innerHTML = '<div class="p-10">Error: Node not found</div>';
    if(node && node.type === 'email') lastEmailId = node.id;

    // チャットノードに入った時の初期化処理
    if(node.type === 'chat' && chatHistory.length === 0) {
         if(node.messages && node.messages[0] && node.messages[0].text) {
             chatHistory.push({sender: 'them', text: node.messages[0].text});
         }
         if(node.initialImage) {
             chatHistory.push({sender: 'them', image: node.initialImage});
         }
         chatCount = 0;
    }

    let html = '';
    // Status Bar with Realtime Clock
    const timeStr = getFormattedTime();
    
    html += '<div class="h-6 bg-white/0 absolute w-full top-0 flex justify-between px-4 pt-1 z-50 text-xs font-bold pointer-events-none ' + (node.type === 'os_home' ? 'text-white' : 'text-slate-800') + '"><span>' + timeStr + '</span><span>100%</span></div>';

    // Main Content Area
    html += '<div class="w-full h-full fade-in relative">';
    
    if(node.type === 'os_home') {
        // Check for auto-transition (notification)
        if(node.next) {
            let nextNode = gameData.nodes.find(n => n.id === node.next);

            // Handle explicit Delay Node (Skip it and look at the next one)
            if(nextNode && nextNode.type === 'delay' && nextNode.next) {
                nextNode = gameData.nodes.find(n => n.id === nextNode.next);
            }

            // If next is a notification type, switch to virtual_home mode to handle delay
            if(nextNode && (nextNode.type === 'chat' || nextNode.type === 'email' || nextNode.type === 'phone')) {
                pendingNode = nextNode;
                currentNodeId = 'virtual_home'; // Switch state
                renderVirtualHome(root, node);
                return;
            }
        }
        html += getHomeHTML(node);
    } 
    else if(node.type === 'opening') {
        const inputHtml = node.requirePlayerName ? `<div class="mb-4 w-full max-w-xs fade-in" style="animation-delay: 2s;"><input type="text" id="player-name-input" class="w-full bg-transparent border-b border-white/50 text-white text-center py-2 focus:outline-none focus:border-white placeholder-white/30" placeholder="名前を入力してください"></div>` : '';
        const btnAction = node.requirePlayerName ? `const name = document.getElementById('player-name-input').value; if(!name) { alert('名前を入力してください'); return; } gameData.playerName = name; triggerNext('${node.next}')` : `triggerNext('${node.next}')`;
        
        html += `
            <div class="h-full w-full bg-black flex flex-col items-center justify-center p-8 text-center fade-in">
                <div class="text-white font-mono text-sm leading-loose mb-8">
                    ${(node.text || '物語が始まります...').split('').map((char, i) => 
                        `<span style="animation: fadeIn 0.1s forwards; animation-delay: ${i * 0.05}s; opacity: 0;">${char}</span>`
                    ).join('')}
                </div>
                ${inputHtml}
                <button onclick="${btnAction}" class="px-6 py-2 border border-white/30 text-white text-xs tracking-widest hover:bg-white/10 transition opacity-0" style="animation: fadeIn 1s forwards; animation-delay: ${(node.text || '').length * 0.05 + 0.5}s">
                    ${node.buttonText || 'START'}
                </button>
                <style>
                    @keyframes fadeIn { to { opacity: 1; } }
                </style>
            </div>
        `;
    }
    else if(node.type === 'search') {
        html += `
            <div class="bg-white h-full flex flex-col pt-12 px-6 relative">
                <button class="absolute top-4 left-4 text-slate-400 hover:text-slate-600 flex items-center gap-1" onclick="currentNodeId='virtual_home'; render();"><i data-lucide="chevron-left"></i> Home</button>
                <div class="text-center mb-8"><span class="text-4xl font-bold text-slate-700"><span class="text-blue-500">G</span>oogle</span></div>
                <input type="text" id="search-input" class="w-full border border-slate-300 rounded-full py-3 px-5 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="検索...">
                <button onclick="handleSearch()" class="mt-4 bg-slate-100 text-slate-600 px-6 py-2 rounded text-sm mx-auto hover:bg-slate-200">Google 検索</button>
                <div class="mt-10 p-4 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-100">Hint: ${node.hint}</div>
            </div>
        `;
    }
    else if(node.type === 'web') {
        html += `
            <div class="bg-white h-full flex flex-col pt-8">
                <div class="bg-slate-100 border-b p-2 flex items-center gap-2 text-xs text-slate-500 px-4">
                    <button class="hover:text-slate-800" onclick="currentNodeId='virtual_home'; render();"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <i data-lucide="lock" class="w-3 h-3"></i> <div class="bg-white px-2 py-1 rounded flex-1">${node.url}</div>
                </div>
                <div class="flex-1 overflow-y-auto relative">
                    ${node.html}
                </div>
            </div>
        `;
    }
    else if(node.type === 'form') {
        html += `
            <div class="bg-white h-full flex flex-col pt-8 overflow-y-auto">
                <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                    <h2 class="font-bold">${node.title || '応募フォーム'}</h2>
                    <button class="text-sm text-slate-300 hover:text-white" onclick="currentNodeId='virtual_home'; render();">✕ 閉じる</button>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-sm text-slate-600 mb-4">${node.description || '以下のフォームに入力してください'}</p>
                    <div><label class="text-xs font-bold text-slate-500">氏名</label><input type="text" class="w-full border p-2 rounded" value="山田 太郎"></div>
                    <div><label class="text-xs font-bold text-slate-500">志望動機</label><textarea class="w-full border p-2 rounded h-24">貴塾の教育理念に共感し...</textarea></div>
                    <button onclick="handleFormSubmit('${node.next}')" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg shadow mt-4 hover:bg-orange-600">${node.submitText || '送信する'}</button>
                </div>
            </div>
        `;
    }
    else if(node.type === 'delay') {
         html += `<div class="h-full bg-black flex items-center justify-center"><div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div></div>`;
         setTimeout(() => triggerNext(node.next), node.duration || 2000);
    }
    else if(node.type === 'phone') {
        html += `
            <div class="h-full w-full mesh-bg flex flex-col items-center pt-24 text-white relative overflow-hidden">
                <!-- Top Status Bar -->
                <div class="absolute top-0 w-full flex justify-between px-4 py-2 text-xs font-bold text-slate-500 z-20">
                    <span>${getFormattedTime()}</span>
                    <div class="flex gap-1">
                        <i data-lucide="wifi" class="w-3 h-3"></i>
                        <i data-lucide="battery" class="w-3 h-3"></i>
                    </div>
                </div>


                <!-- Caller Info -->
                <button class="absolute top-10 left-4 z-30 text-white/80 hover:text-white transition" onclick="currentNodeId='virtual_home'; render();">
                    <i data-lucide="chevron-left" class="w-8 h-8 drop-shadow-md"></i>
                </button>
                <div class="flex flex-col items-center mt-12 mb-8 z-10">
                    <div class="w-32 h-32 rounded-full bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center mb-6 shadow-2xl ring-4 ring-white/20 overflow-hidden">
                        ${node.callerIcon ? `<img src="${node.callerIcon}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-16 h-16 text-slate-500"></i>`}
                    </div>
                    <h2 class="text-3xl font-bold mb-2 shadow-black/10 drop-shadow-md">${node.caller}</h2>
                    <div id="call-timer" class="text-sm opacity-80 font-mono font-medium">00:00</div>
                </div>
                
                <!-- Answer Button (Initial State) -->
                <div id="incoming-ui" class="absolute bottom-24 w-full flex justify-center z-20">
                    <div class="flex flex-col items-center gap-3 cursor-pointer group" onclick="startCall()">
                        <div class="w-20 h-20 rounded-full bg-green-500/90 backdrop-blur-md flex items-center justify-center animate-bounce shadow-lg shadow-green-500/40 border-4 border-white/20 transition hover:scale-105">
                            <i data-lucide="phone" class="w-8 h-8 text-white fill-current"></i>
                        </div>
                        <span class="text-sm font-bold tracking-wider shadow-black/20 drop-shadow-sm">応答</span>
                    </div>
                </div>

                <!-- Active Call UI (Hidden initially) -->
                <div id="call-active-ui" class="hidden absolute inset-0 flex flex-col items-center justify-between pb-12 pt-40 z-30 mesh-bg">
                    <div class="flex flex-col items-center">
                        <div class="w-32 h-32 rounded-full bg-slate-200 flex items-center justify-center mb-6 shadow-xl overflow-hidden ring-4 ring-white/20">
                             ${node.callerIcon ? `<img src="${node.callerIcon}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-16 h-16 text-slate-500"></i>`}
                        </div>
                        <h2 class="text-2xl font-bold mb-2 text-slate-800">${node.caller}</h2>
                        <div id="active-timer" class="text-sm text-slate-500 font-mono font-medium">00:00</div>
                    </div>

                    <!-- Control Icons -->
                    <div class="w-full px-8">
                        <div class="glass-panel rounded-3xl p-6 mb-8 mx-4 flex justify-around items-center">
                            <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition cursor-pointer">
                                <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center"><i data-lucide="mic-off" class="text-slate-600"></i></div>
                                <span class="text-[10px] text-slate-600 font-bold">消音</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition cursor-pointer">
                                <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center"><i data-lucide="video" class="text-slate-600"></i></div>
                                <span class="text-[10px] text-slate-600 font-bold">ビデオ</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition cursor-pointer">
                                <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center"><i data-lucide="volume-2" class="text-slate-600"></i></div>
                                <span class="text-[10px] text-slate-600 font-bold">スピーカー</span>
                            </div>
                        </div>

                        <!-- Hang Up Button -->
                        <div class="flex justify-center">
                            <div class="w-20 h-20 rounded-full bg-red-500 flex items-center justify-center shadow-xl shadow-red-500/30 hover:bg-red-600 transition cursor-pointer" onclick="endCall('${node.next}')">
                                <i data-lucide="phone-off" class="w-10 h-10 text-white fill-current"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    else if(node.type === 'email') {
        html += `
            <div class="bg-white h-screen flex flex-col pt-8">
                <div class="bg-slate-50 border-b p-4 flex justify-between items-center">
                    <span class="text-blue-600 font-bold" onclick="currentNodeId='virtual_inbox'; render();">＜ 受信箱</span>
                </div>
                <div class="p-5 flex-1 overflow-y-auto">
                    <h1 class="font-bold text-lg mb-4">${node.subject}</h1>
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">${node.sender[0]}</div>
                        <div><div class="text-sm font-bold">${node.sender}</div><div class="text-xs text-slate-400">To: 自分</div></div>
                    </div>
                    <div class="text-slate-800 leading-relaxed whitespace-pre-wrap text-sm">${node.body}</div>

                    ${node.linkText ? `<button onclick="triggerNext('${node.next}')" class="mt-8 w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700">${node.linkText}</button>` : ''}
                </div>
            </div>
        `;
    }
    if (node.type === 'video') {
        html += `
            <div class="bg-slate-900 h-full relative">
                 <img src="${node.image}" class="w-full h-full object-cover opacity-80">
                 <div class="absolute bottom-0 w-full h-40 bg-gradient-to-t from-black/90 to-transparent p-6">
                    <div class="text-white font-bold text-lg mb-1">${node.streamName}</div>
                     <div class="text-white/80 text-sm italic mb-4">"${node.script}"</div>
                     <div class="flex gap-4 justify-center">
                        <button class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white"><i data-lucide="mic-off"></i></button>
                        <button class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center text-white" onclick="triggerNext('${node.next}')"><i data-lucide="phone-off"></i></button>
                     </div>
                 </div>
            </div>
        `;
    } else if (node.type === 'chat') {
        // Enhanced Chat Export
        const apiKeyField = node.chatMode === 'ai' && !node.apiKey && !gameData.globalApiKey ? '<div class="px-4 py-2 bg-yellow-50 text-xs text-yellow-700 mb-2">API Key Required</div><input type="password" id="user-api-key" placeholder="Gemini API Key" class="w-full border p-2 mb-2 rounded text-xs">' : '';
        const forceEndBtn = node.chatMode === 'ai' ? '<button onclick="evaluateChat(gameData.nodes.find(n => n.id === currentNodeId))" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded ml-auto">会話終了</button>' : '';

        // Use node.initialMessages or empty array for static export
        // Use dynamic chatHistory for stateful rendering
        const exportChatHistory = chatHistory;
        const bubblesHtml = exportChatHistory.map(m => {
            const iconHtml = m.sender === 'them'
                ? (node.icon ? `<img src="${node.icon}" class="w-8 h-8 rounded-full border border-slate-200 object-cover flex-shrink-0 self-end mb-1">` 
                             : `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 shadow-sm flex-shrink-0 self-end mb-1"></div>`)
                : '';

            if (m.image) {
                return `
                    <div class="flex gap-2 ${m.sender === 'me' ? 'flex-row-reverse' : ''} mb-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
                        ${iconHtml}
                        <div class="p-1 rounded-2xl shadow-sm ${m.sender === 'me' ? 'bg-[#007AFF] rounded-tr-sm' : 'bg-white rounded-tl-sm border border-slate-100'} max-w-[75%]">
                            <img src="${m.image}" class="rounded-lg max-w-full h-auto">
                        </div>
                    </div>
                `;
            } else if (m.text) {
                const lines = m.text.split('\n');
                return lines.map(line => {
                    if (!line.trim()) return '';
                    return `
                        <div class="flex gap-2 ${m.sender === 'me' ? 'flex-row-reverse' : ''} mb-1 animate-in fade-in slide-in-from-bottom-1 duration-200">
                             ${iconHtml}
                            <div class="px-3.5 py-2 rounded-2xl shadow-sm text-sm max-w-[75%] leading-relaxed ${m.sender === 'me' ? 'bg-[#007AFF] text-white rounded-br-sm' : 'bg-white text-slate-800 rounded-bl-sm border border-slate-100'}">
                                ${line}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            return '';
        }).join('');

        html += `
            <div class="h-full bg-slate-50 flex flex-col pt-10 relative overflow-hidden">
                 <!-- Background Blur -->
                 <div class="absolute inset-0 bg-blue-500/5 pointer-events-none"></div>

                 <!-- Chat Header -->
                 <div class="absolute top-0 w-full z-20 bg-white/70 backdrop-blur-xl border-b border-white/20 pt-10 pb-3 px-4 shadow-sm flex items-center gap-3">
                    <button class="text-blue-500 flex items-center gap-1 text-sm font-medium hover:opacity-70 transition" onclick="currentNodeId='virtual_home'; render();">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-white text-xs font-bold shadow-inner">
                        ${node.partner ? node.partner.charAt(0) : 'U'}
                    </div>
                    <div class="flex-1 flex flex-col justify-center">
                        <span class="font-bold text-sm text-slate-800 leading-tight">${node.partner}</span>
                        <span class="text-[10px] text-slate-500 leading-tight">Active now</span>
                    </div>
                    ${forceEndBtn}
                 </div>

                 <!-- Chat Body -->
                 <div id="chat-messages" class="flex-1 p-4 pt-20 overflow-y-auto space-y-4 pb-24 scrollbar-hide">
                    ${apiKeyField}
                    <div class="text-center py-4 text-xs text-slate-400 font-medium">Today ${getFormattedTime()}</div>
                    ${bubblesHtml}
                 </div>

                 <!-- Input Area -->
                 <div class="absolute bottom-0 w-full p-3 bg-white/80 backdrop-blur-xl border-t border-white/20 flex items-end gap-2 z-20 pb-6">
                    <button class="p-2 text-slate-400 hover:text-blue-500 transition"><i data-lucide="plus" class="w-6 h-6"></i></button>
                    <div class="flex-1 bg-slate-100 border border-slate-200 rounded-2xl flex items-center px-3 py-1 focus-within:ring-2 focus-within:ring-blue-500/50 transition">
                        <input type="text" id="chat-input" class="w-full bg-transparent border-none text-sm text-slate-900 placeholder-slate-400 focus:ring-0 py-2 h-auto max-h-24 resize-none" placeholder="メッセージ" onkeypress="if(event.key === 'Enter') handleChatSend()">
                        <button class="ml-1 p-1 text-slate-400 hover:text-blue-500"><i data-lucide="mic" class="w-4 h-4"></i></button>
                    </div>
                    <button onclick="handleChatSend()" class="w-10 h-10 rounded-full bg-[#007AFF] flex items-center justify-center text-white hover:bg-blue-600 transition shadow-lg hover:shadow-blue-500/30 active:scale-95">
                        <i data-lucide="arrow-up" class="w-5 h-5 font-bold"></i>
                    </button>
                </div>
                
                 <!-- Chat Loading Overlay -->
                 <div id="chat-loading" class="hidden absolute inset-0 bg-black/20 z-50 flex items-center justify-center">
                    <div class="bg-white/90 backdrop-blur p-4 rounded-2xl shadow-lg text-xs font-bold flex items-center gap-2 border border-white/50">
                        <div class="w-4 h-4 border-2 border-blue-500 rounded-full animate-spin border-t-transparent"></div>
                        <span class="text-slate-700">採点中...</span>
                    </div>
                 </div>
            </div>
        `;
} else if (node.type === 'ending') {
    // Glitch Ending
    html += `
        <div class="glitch-container">
                <div class="glitch-layer"></div>
                <div class="scanline"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <h1 class="glitch-text text-4xl tracking-widest">GAME CLEAR</h1>
                </div>
                <div class="credits-scroll">
                    <div class="text-lg font-bold mb-8">STAFF ROLL</div>
                    <div class="whitespace-pre-wrap leading-loose text-sm opacity-80">${node.credits || 'Thank you for playing.'}</div>
                </div>
            </div >
    `;
        
        // Auto-advance after credits (approx 12s) to Evaluation
        setTimeout(() => {
             // Find the last chat node to evaluate
             // In this simple flow, it's likely the node before this one, or we search for a chat node
             const chatNodes = gameData.nodes.filter(n => n.type === 'chat' && n.chatMode === 'ai');
             const lastChatNode = chatNodes[chatNodes.length - 1];
             
             if (lastChatNode) {
                 // Trigger evaluation using the last chat node's config, but transition to THIS node's next (Result)
                 evaluateChat(lastChatNode, node.next);
             } else {
                 triggerNext(node.next);
             }
        }, 12000);
    }
    else if(node.type === 'result') {
         // Enhanced Rubric Table with Score Display
         let rubricTable = '';
         let scoreBreakdown = '';
         
         if(gameData.ice && gameData.ice.rubricMatrix && gameData.ice.rubricMatrix.length > 0) {
             // Calculate total possible score
             const maxScore = gameData.ice.rubricMatrix.reduce((sum, r) => sum + (r.i_score || 0) + (r.c_score || 0) + (r.e_score || 0), 0);
             
             // Generate score breakdown
             scoreBreakdown = `
        <div class="bg-white/10 rounded-xl p-4 mb-4 text-left w-full max-w-sm" >
                    <h3 class="text-sm font-bold text-white mb-3 border-b border-white/20 pb-2">📊 評価結果</h3>
                    
                    <div class="text-center mb-4">
                        <div class="text-5xl font-bold text-yellow-400">${gameScore}</div>
                        <div class="text-sm text-slate-400">/ ${maxScore || 100} 点</div>
                    </div>
                    
                    ${
        scoreDetails.feedback ? `
                        <div class="space-y-2 text-xs">
                            <div class="bg-green-500/20 p-3 rounded border border-green-500/30">
                                <div class="font-bold text-green-400 mb-1">✓ 良かった点</div>
                                <div class="text-white">${scoreDetails.feedback.good || '—'}</div>
                            </div>
                            <div class="bg-orange-500/20 p-3 rounded border border-orange-500/30">
                                <div class="font-bold text-orange-400 mb-1">↗ アドバイス</div>
                                <div class="text-white">${scoreDetails.feedback.improvement || '—'}</div>
                            </div>
                        </div>
                    ` : (scoreDetails.reason ? `<div class="text-xs text-slate-300 p-2 bg-blue-500/20 rounded">${scoreDetails.reason}</div>` : '')
    }
                </div>
        `;

             // Generate Score Table by Category
             const getScore = (cat, type) => {
                 if(scoreDetails && scoreDetails.details && scoreDetails.details[cat] && scoreDetails.details[cat][type] !== undefined) {
                     return scoreDetails.details[cat][type];
                 }
                 return '—';
             };

             rubricTable = `
        <div class="w-full max-w-sm" >
                    <button onclick="document.getElementById('rubric-modal').classList.remove('hidden')" class="w-full bg-white/20 hover:bg-white/30 text-white py-3 rounded-lg text-sm font-bold border border-white/40 flex items-center justify-center gap-2 transition">
                        <i data-lucide="table"></i> 詳細ルーブリックを確認
                    </button>
                    
                    <!--Rubric Modal-->
        <div id="rubric-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
            <div class="bg-white text-slate-800 rounded-xl w-full max-w-lg max-h-[85vh] overflow-y-auto relative shadow-2xl">
                <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 flex justify-between items-center rounded-t-xl">
                    <div>
                        <h3 class="font-bold text-lg">ICE評価ルーブリック</h3>
                        <p class="text-xs opacity-80">総合スコア: ${gameScore}点</p>
                    </div>
                    <button onclick="document.getElementById('rubric-modal').classList.add('hidden')" class="p-2 hover:bg-white/20 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-4">
                    ${scoreDetails.feedback ? `
                                    <div class="mb-4 space-y-2">
                                        <div class="p-3 bg-green-50 border-l-4 border-green-500 rounded-r">
                                            <strong class="text-green-700 block text-sm mb-1">良かった点</strong>
                                            <p class="text-xs text-green-800">${scoreDetails.feedback.good || 'No feedback'}</p>
                                        </div>
                                        <div class="p-3 bg-amber-50 border-l-4 border-amber-500 rounded-r">
                                            <strong class="text-amber-700 block text-sm mb-1">改善へのアドバイス</strong>
                                            <p class="text-xs text-amber-800">${scoreDetails.feedback.improvement || 'No advice'}</p>
                                        </div>
                                    </div>
                                ` : ''}

                    <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse">
                            <thead>
                                <tr class="bg-slate-100">
                                    <th class="p-2 border text-left font-bold">評価項目</th>
                                    <th class="p-2 border text-center bg-orange-50 text-orange-700 font-bold">I: 基礎</th>
                                    <th class="p-2 border text-center bg-cyan-50 text-cyan-700 font-bold">C: 関連</th>
                                    <th class="p-2 border text-center bg-purple-50 text-purple-700 font-bold">E: 応用</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${gameData.ice.rubricMatrix.map(row => `
                                                <tr class="hover:bg-slate-50">
                                                    <td class="p-2 border font-bold bg-slate-50">${row.category}</td>
                                                    <td class="p-2 border text-center">
                                                        <div class="text-lg font-bold text-orange-600">${getScore(row.category, 'I')}</div>
                                                        <div class="text-[10px] text-slate-400">/${row.i_score}</div>
                                                        <div class="text-[9px] text-slate-500 mt-1">${row.i_text}</div>
                                                    </td>
                                                    <td class="p-2 border text-center">
                                                        <div class="text-lg font-bold text-cyan-600">${getScore(row.category, 'C')}</div>
                                                        <div class="text-[10px] text-slate-400">/${row.c_score}</div>
                                                        <div class="text-[9px] text-slate-500 mt-1">${row.c_text}</div>
                                                    </td>
                                                    <td class="p-2 border text-center">
                                                        <div class="text-lg font-bold text-purple-600">${getScore(row.category, 'E')}</div>
                                                        <div class="text-[10px] text-slate-400">/${row.e_score}</div>
                                                        <div class="text-[9px] text-slate-500 mt-1">${row.e_text}</div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
                </div>
        `;
         }

         // Certificate HTML
         const today = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
         const isPassed = gameScore >= (parseInt(node.scoreThreshold) || 60);
         
         // Rank Calculation
         let rank = 'スタッフ';
         let totalI = 0, totalC = 0, totalE = 0;
         let maxI = 0, maxC = 0, maxE = 0;

         if (gameData.ice && gameData.ice.rubricMatrix) {
             gameData.ice.rubricMatrix.forEach(row => {
                 maxI += parseInt(row.i_score) || 0;
                 maxC += parseInt(row.c_score) || 0;
                 maxE += parseInt(row.e_score) || 0;

                 if (scoreDetails && scoreDetails.details && scoreDetails.details[row.category]) {
                     totalI += scoreDetails.details[row.category].I || 0;
                     totalC += scoreDetails.details[row.category].C || 0;
                     totalE += scoreDetails.details[row.category].E || 0;
                 }
             });
         }
         
         const totalMax = maxI + maxC + maxE;

         if (gameScore >= totalMax) {
             rank = 'マスター';
         } else if (totalC >= maxC && totalE >= (0.9 * maxE)) {
             rank = 'トレーナー';
         } else if (totalI >= maxI && totalC >= (0.9 * maxC)) {
             rank = 'サブトレーナー';
         } else if (totalI >= maxI) {
             rank = 'スター';
         }

         let certificateHtml = '';

         // Rank-based Default Texts
         const rankTexts = {
             'マスター': "あなたは本プロジェクトにおいて、極めて卓越した成果を上げ、他の模範となる素晴らしい活躍をされました。\nその高度な専門性とリーダーシップを称え、ここにマスターとして認定いたします。",
             'トレーナー': "あなたは本プロジェクトにおいて、優れた成果を上げ、チームの成長に大きく貢献されました。\nその指導力と実務能力を称え、ここにトレーナーとして認定いたします。",
             'サブトレーナー': "あなたは本プロジェクトにおいて、一定の成果を上げ、着実な成長を示されました。\nその努力と今後の可能性を評価し、ここにサブトレーナーとして認定いたします。",
             'スタッフ': "あなたは本プロジェクトに参加し、最後まで粘り強く取り組みました。\nその参加意欲と経験を称え、ここにスタッフとして認定いたします。"
         };

         const defaultGoodText = "本プロジェクトにおいて、所定の要件を満たし優れた成果を上げたことを、ここに証します。";

         if (isPassed) {
             // Pass: Certificate (認定証)
             let certText = node.certificateGood || defaultGoodText;
             
             // Use rank-specific text if using default
             if (certText === defaultGoodText && rankTexts[rank]) {
                 certText = rankTexts[rank];
             }
             
             // Fix newlines
             certText = certText.replace(/\n/g, '<br>');
             
             const playerName = gameData.playerName || "あなた";
             
             certificateHtml = `
        <div id="certificate-container" class="relative bg-gradient-to-br from-white via-blue-50 to-purple-50 p-8 rounded-none shadow-xl mx-auto w-full max-w-lg aspect-[1.414/1] text-slate-900 border-8 border-double border-slate-200 overflow-hidden flex flex-col justify-between" >
                    
                    <!-- Badge -->
                    <div class="absolute top-6 left-0 right-0 flex justify-center">
                        <div class="bg-yellow-400 text-slate-900 font-bold px-6 py-1 rounded-full shadow-md tracking-wider text-sm">
                            RANK ${rank}
                        </div>
                    </div>

                    <!-- Title -->
                    <div class="mt-16 text-center">
                        <h2 class="text-4xl md:text-5xl font-bold text-slate-900 mb-2 font-serif tracking-widest">認定証</h2>
                    </div>

                    <!-- Recipient -->
                    <div class="text-center mt-4 mb-4">
                        <div class="text-xl md:text-2xl font-bold border-b border-slate-400 inline-block pb-1 px-8 font-serif">
                            ${playerName} 様
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="flex-1 px-4 flex items-center justify-center">
                        <p class="text-sm md:text-base text-slate-700 leading-loose font-serif whitespace-pre-wrap text-center">${certText}</p>
                    </div>

                    <!-- Footer -->
                    <div class="mt-4 flex flex-col items-center text-center">
                        <div class="text-sm font-serif mb-4">認定日 ${today}</div>
                        <div class="text-lg font-bold text-slate-800 font-serif">仕事先の社名</div>
                    </div>
                </div>
        <button onclick="downloadCertificate()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow mb-4 flex items-center justify-center gap-2 mt-4 transition">
            <i data-lucide="download"></i> 認定証を保存する
        </button>
    `;
         } else {
             // Fail: Termination Notice (退職辞令)
             let certText = node.certificateBad || "貴殿は本プロジェクトにおいて期待される成果を上げることができませんでした。\nよって、本日付でプロジェクトからの退任を命じます。";
             
             // Fix newlines
             certText = certText.replace(/\n/g, '<br>');

             const playerName = gameData.playerName || "あなた";

             certificateHtml = `
        <div id="certificate-container" class="bg-black text-white p-8 rounded-none shadow-xl mx-auto w-full max-w-lg aspect-[1.414/1] border border-slate-800 font-serif flex flex-col justify-between items-center text-center relative overflow-hidden" >
                    
                    <!-- Title -->
                    <div class="mt-12">
                        <h2 class="text-4xl md:text-5xl font-bold mb-8 tracking-widest text-red-600 font-serif">退職辞令</h2>
                    </div>
                    
                    <!-- Recipient -->
                    <div class="w-full mb-8">
                        <div class="text-xl md:text-2xl font-bold border-b border-white/50 inline-block pb-1 px-8 font-serif">
                            ${playerName} 様
                        </div>
                    </div>
                    
                    <!-- Body -->
                    <div class="flex-1 px-4 w-full flex items-center justify-center">
                        <div class="text-sm md:text-base leading-loose text-red-100/90 whitespace-pre-wrap font-serif">${certText}</div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="mt-8 w-full flex flex-col items-center">
                        <div class="text-sm text-red-200/70 mb-4 font-serif">${today}</div>
                        <div class="text-2xl font-bold text-red-600 font-serif">仕事先の社名</div>
                    </div>
                </div>
        <button onclick="downloadCertificate()" class="w-full bg-red-900/50 hover:bg-red-900 text-red-100 py-3 rounded-lg font-bold shadow mb-4 flex items-center justify-center gap-2 mt-4 transition border border-red-800">
            <i data-lucide="download"></i> 辞令を保存する
        </button>
    `;
         }

         html += `
        <div class="h-full bg-gradient-to-b from-slate-900 to-indigo-900 flex flex-col items-center p-6 text-center text-white overflow-y-auto" >
                <div class="mb-4 flex-shrink-0">
                    <div class="w-20 h-20 mx-auto mb-2 rounded-full bg-gradient-to-br ${node.isGood ? 'from-yellow-400 to-orange-500' : 'from-red-500 to-pink-500'} flex items-center justify-center shadow-lg">
                        <i data-lucide="${node.isGood ? 'trophy' : 'alert-circle'}" class="w-10 h-10 text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold mb-1">${node.title}</h1>
                    <p class="text-sm text-slate-300">${node.message}</p>
                </div>
                
                <div class="w-full max-w-sm flex-shrink-0">
                    ${certificateHtml}
                </div>
                
                <div class="w-full max-w-sm flex-shrink-0">
                    ${scoreBreakdown}
                    ${rubricTable}
                </div>
                
                <div class="mt-4 text-xs text-slate-500 pb-8 flex-shrink-0">
                    お疲れ様でした！
                </div>
            </div>
        `;
    }

    html += '</div>';
    root.innerHTML = html;
    if(window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
    }
    
    if(node.type === 'chat') {
        const chatContainer = document.getElementById('chat-messages');
        if(chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

// --- 仮想ホーム画面の描画ヘルパー ---
function getHomeHTML(node) {
    // Notification Logic
    var notifHTML = '';
    
    // Build Notification if needed
    if (pendingNode) {
        var notifTitle = 'New Notification';
        var notifBody = 'You have a new message';
        var iconType = 'mail';

        if(pendingNode.type === 'email') {
            notifTitle = pendingNode.sender;
            notifBody = pendingNode.subject;
            iconType = 'mail';
        } else if(pendingNode.type === 'chat') {
            notifTitle = pendingNode.partner;
            // Use initial message or first message for notification body
            notifBody = (pendingNode.messages && pendingNode.messages[0] && pendingNode.messages[0].text) 
                        ? pendingNode.messages[0].text.substring(0, 30) + '...'
                        : '新着メッセージがあります';
            iconType = 'message-circle';
        } else if (pendingNode.type === 'search') {
            notifTitle = 'Search';
            notifBody = 'Tap to open search';
            iconType = 'search';
        }
        
        // Use simple string concatenation to avoid template literal nesting issues
        // Remove onclick from here, as it shouldn't be clickable until shown
        var bannerAction = "openApp('" + pendingNode.id + "')";
        if(pendingNode.type === 'email') bannerAction = "currentNodeId='virtual_inbox'; render()";

        notifHTML = '<div id="home-notif" class="notification" onclick="' + bannerAction + '">' +
                    '<div class="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center text-white"><i data-lucide="' + iconType + '"></i></div>' +
                    '<div>' +
                    '<div class="font-bold text-xs text-slate-900">' + notifTitle + '</div>' +
                    '<div class="text-xs text-slate-500 truncate w-48">' + notifBody + '</div>' +
                    '</div>' +
                    '</div>';
    }

    // Build App Grid HTML safely without nested template literals
    var appsHtml = ['phone', 'message-circle', 'search', 'mail', 'camera', 'photos', 'maps', 'settings'].map(function(icon) {
        var clickAction = "";
        // Allow re-opening last email
        if (icon === 'mail') {
             clickAction = "currentNodeId='virtual_inbox'; render()";
        }
        var iconId = 'app-icon-' + icon;
        
        // Logic for App Click
        if(pendingNode) {
            if((icon === 'mail' && pendingNode.type === 'email') ||
               (icon === 'message-circle' && pendingNode.type === 'chat') ||
               (icon === 'search' && pendingNode.type === 'search') ||
               (icon === 'phone' && pendingNode.type === 'phone')) {
                clickAction = (icon === 'mail') ? "currentNodeId='virtual_inbox'; render()" : "openApp('" + pendingNode.id + "')";
            }
        } 
        else if (node && node.apps && node.apps.includes(icon)) {
            if(icon === 'search' && node.next) {
                clickAction = "triggerNext('" + node.next + "')";
            }
        }

        // Icons handled by CSS/Lucide, uniform look
        var bgStyle = 'bg-white/20 backdrop-blur-md border border-white/30';
        var iconColor = 'text-white';
        
        // Use consistent shape
        return '<div id="' + iconId + '" class="flex flex-col items-center gap-1 group cursor-pointer transition transform hover:scale-105 active:scale-95" onclick="' + clickAction + '">' +
                '<div class="w-[58px] h-[58px] ' + bgStyle + ' rounded-[16px] flex items-center justify-center text-white shadow-lg shadow-black/5 transition">' +
                '<i data-lucide="' + icon + '" class="w-7 h-7 drop-shadow-sm"></i>' +
                '</div>' +
                '<span class="text-[10px] font-medium text-white tracking-wide drop-shadow-md capitalize">' + icon + '</span>' +
                // Badge placeholder (appended via JS)
                '</div>';
    }).join('');

    // Dock Apps (subset)
    var dockAppsHtml = ['phone', 'message-circle', 'search', 'music'].map(function(icon) {
         var clickAction = "";
         // ... simplified reuse logic ...
         if(pendingNode && ((icon === 'mail' && pendingNode.type === 'email') || (icon === 'message-circle' && pendingNode.type === 'chat') || (icon === 'search' && pendingNode.type === 'search') || (icon === 'phone' && pendingNode.type === 'phone'))) {
             clickAction = "openApp('" + pendingNode.id + "')";
         }
         
         var bgClass = 'bg-white/20'; // Default
         if(icon === 'phone') bgClass = 'bg-green-500/90';
         if(icon === 'message-circle') bgClass = 'bg-green-400/90';
         
         return '<div class="flex flex-col items-center group cursor-pointer transition transform hover:scale-110 active:scale-95" onclick="' + clickAction + '">' +
                 '<div class="w-[58px] h-[58px] ' + bgClass + ' backdrop-blur-md border border-white/20 rounded-[16px] flex items-center justify-center text-white shadow-lg">' +
                 '<i data-lucide="' + icon + '" class="w-7 h-7 text-white drop-shadow-sm"></i>' +
                 '</div>' +
                 '</div>';
    }).join('');

    return '<div class="h-full w-full mesh-bg flex flex-col pt-12 relative overflow-hidden">' +
           // Status Bar Blur
           '<div class="absolute top-0 w-full h-8 bg-black/10 backdrop-blur-[2px] z-10"></div>' +
           // Main Content
           notifHTML +
           '<div class="flex-1 grid grid-cols-4 content-start gap-x-4 gap-y-6 p-6">' +
           appsHtml +
           '</div>' +
           // Dock
           '<div class="p-4 pb-8 mb-2 mx-4">' +
           '<div class="bg-white/20 backdrop-blur-xl border border-white/20 rounded-[28px] p-4 flex justify-around items-center shadow-[0_8px_32px_rgba(0,0,0,0.2)]">' +
           dockAppsHtml +
           '</div>' +
           '</div>' +
           '</div>';
}


function renderVirtualInbox(root) {
    let html = `
        <div class="bg-gray-100 h-screen flex flex-col pt-8">
             <div class="bg-white/90 backdrop-blur-md border-b px-4 py-3 flex justify-between items-center sticky top-0 z-10 shadow-sm text-slate-800">
                <button class="text-blue-600 font-bold flex items-center gap-1" onclick="currentNodeId='virtual_home'; render();">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i> ホーム
                </button>
                <span class="font-bold">受信トレイ</span>
                <span class="w-12 text-right text-blue-600 font-medium text-sm" onclick="render()">更新</span>
            </div>
            <div class="p-0 flex-1 overflow-y-auto">
    `;
    
    let emails = [];
    if (pendingNode && pendingNode.type === 'email') {
         emails.push({ ...pendingNode, unread: true });
    }
    if (lastEmailId && (!pendingNode || pendingNode.id !== lastEmailId)) {
         const last = gameData.nodes.find(n => n.id === lastEmailId);
         if (last) emails.push({ ...last, unread: false });
    }
    
    if (emails.length === 0) {
        html += '<div class="p-10 text-center text-gray-400 text-sm mt-10">メッセージはありません</div>';
    } else {
         emails.forEach(node => {
             const preview = node.body ? node.body.substring(0, 40).replace(/\n/g, ' ') + '...' : '';
             html += `
                <div class="bg-white border-b pl-4 pr-3 py-3 flex gap-3 active:bg-gray-50 cursor-pointer transition" onclick="openApp('${node.id}')">
                     <div class="mt-2 w-2.5 h-2.5 rounded-full ${node.unread ? 'bg-blue-600' : 'bg-transparent'} flex-shrink-0"></div>
                     <div class="flex-1 min-w-0">
                         <div class="flex justify-between mb-0.5 items-baseline">
                             <div class="font-bold text-base text-slate-900 truncate">${node.sender}</div>
                             <div class="text-xs text-slate-400">Now</div>
                         </div>
                         <div class="font-medium text-sm text-slate-800 mb-0.5 truncate">${node.subject}</div>
                         <div class="text-xs text-slate-500 line-clamp-2 leading-tight">${preview}</div>
                     </div>
                     <div class="flex items-center text-slate-300"><i data-lucide="chevron-right" class="w-5 h-5"></i></div>
                </div>
             `;
         });
    }

    html += '</div></div>';
    root.innerHTML = html;
    if(window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
    }
}

function renderVirtualHome(root, homeNode) {
    notificationArrived = false; // Reset notification state
    const node = homeNode || {};
    
    root.innerHTML = '<div class="w-full h-full fade-in relative">' + 
                     '<div class="h-6 bg-white/0 absolute w-full top-0 flex justify-between px-4 pt-1 z-50 text-xs font-bold pointer-events-none text-white"><span>' + getFormattedTime() + '</span><span>100%</span></div>' + 
                     getHomeHTML(node) + 
                     '</div>';
    if(window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
    }

    // Notification Delay Logic - use game settings or default 3 seconds
    const notifDelay = (gameData.gameSettings && gameData.gameSettings.notificationDelay) ? gameData.gameSettings.notificationDelay * 1000 : 3000;
    
    if (pendingNode) {
        setTimeout(function() {
            notificationArrived = true;
            
            // Show Notification Banner
            var notif = document.getElementById('home-notif');
            if(notif) notif.classList.add('show');
            
            // Add Badge to Icon
            var iconType = 'mail'; // default
            if(pendingNode.type === 'chat') iconType = 'message-circle';
            if(pendingNode.type === 'search') iconType = 'search';
            if(pendingNode.type === 'email') iconType = 'mail';
            
            var iconEl = document.getElementById('app-icon-' + iconType);
            if(iconEl) {
                var badge = document.createElement('div');
                badge.className = 'absolute top-0 right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white fade-in';
                iconEl.appendChild(badge);
            }
        }, notifDelay);
    }
}

// --- ロジックヘルパー ---
// 次のノードへ遷移する
function triggerNext(nextId) {
    if(!nextId) return;
    
    const nextNode = gameData.nodes.find(n => n.id === nextId);
    
    // Check for Notification Interception
    if(nextNode && (nextNode.type === 'email' || nextNode.type === 'chat')) {
        pendingNode = nextNode;
        currentNodeId = 'virtual_home';
        render();
        return;
    }

    currentNodeId = nextId;
    render();
}

function handleFormSubmit(nextId) {
    const node = gameData.nodes.find(n => n.id === currentNodeId);
    alert(node.successMessage || "送信しました");
    triggerNext(nextId);
}

function handleSearch() {
    const input = document.getElementById('search-input').value;
    const node = gameData.nodes.find(n => n.id === currentNodeId);
    if(input.includes(node.query)) {
        triggerNext(node.next);
    } else {
        alert('検索結果が見つかりません。ヒントを確認してください。');
    }
}

function downloadCertificate() {
    const element = document.getElementById('certificate-container');
    if(!element) return;
    
    html2canvas(element).then(canvas => {
        const link = document.createElement('a');
        link.download = 'certificate.png';
        link.href = canvas.toDataURL();
        link.click();
    }).catch(err => {
        alert("保存に失敗しました: " + err);
    });
}

function startCall() {
    document.getElementById('incoming-ui').classList.add('hidden');
    document.getElementById('call-active-ui').classList.remove('hidden');
    
    const node = gameData.nodes.find(n => n.id === currentNodeId);
    
    // Determine which audio to play based on score
    const threshold = node.scoreThreshold !== undefined ? parseInt(node.scoreThreshold) : 60; 
    const isPass = gameScore >= threshold;
    const audioSrc = isPass ? node.audioGood : node.audioBad;
    
    // Timer Logic
    let seconds = 0;
    const timerEl = document.getElementById('active-timer');
    const timerInterval = setInterval(() => {
        seconds++;
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        if(timerEl) timerEl.textContent = mins + ':' + secs;
    }, 1000);

    const finishCall = () => {
        clearInterval(timerInterval);
        triggerNext(node.next);
    };

    if (audioSrc || node.audio) {
        const src = audioSrc || node.audio;
        const audio = new Audio(src);
        
        // Wait for audio to end before finishing
        audio.onended = finishCall;
        
        audio.play().catch(e => {
            console.log("Audio play failed:", e);
            // Fallback if audio fails
            setTimeout(finishCall, node.duration || 3000);
        });
    } else {
        // No audio, use duration
        setTimeout(finishCall, node.duration || 3000);
    }
}

async function handleChatSend() {
    try {
    const inputEl = document.getElementById('chat-input');
    const text = inputEl.value;
    if(!text) return;

    const node = gameData.nodes.find(n => n.id === currentNodeId);
    
    // Add User Message
    chatHistory.push({sender: 'me', text: text});
    inputEl.value = '';
    render();

    chatCount++;

    // CHECK EXIT CONDITION
    let shouldExit = false;
    if (node.exitCondition === 'keyword' && text.includes(node.exitValue)) shouldExit = true;
    if (node.exitCondition === 'count' && chatCount >= parseInt(node.exitValue || 3)) shouldExit = true;

    if (shouldExit) {
        if (node.chatMode === 'ai' && node.passNext) {
            // Perform Evaluation
            await evaluateChat(node);
        } else {
            setTimeout(() => triggerNext(node.next), 1000);
        }
        return;
    }

    // GENERATE REPLY
    let replyText = "...";

    if (node.chatMode === 'simple') {
        setTimeout(() => triggerNext(node.next), 1000);
        return;
    } 
    else if (node.chatMode === 'rule') {
        const rules = typeof node.rules === 'string' ? JSON.parse(node.rules || '[]') : (node.rules || []);
        const match = rules.find(r => text.includes(r.key));
        replyText = match ? match.res : "なるほど、他には？"; 
    } 
    else if (node.chatMode === 'ai') {
        // Gemini API Call
        let key = node.apiKey || gameData.globalApiKey;
        if(!key) {
            const userInputKey = document.getElementById('user-api-key');
            if(userInputKey) key = userInputKey.value;
        }
        
        if(!key) {
            replyText = "[System] API Keyが必要です。";
        } else {
            try {
                const model = node.modelName || gameData.gameSettings?.geminiModel || 'gemini-2.5-flash';
                // Use comprehensive system prompt (set during game generation)
                let sysPrompt = node.systemPrompt || "";
                
                // Fallback: Build from ICE data if no system prompt
                if(!sysPrompt && node.useIcePrompt && gameData.ice) {
                     const ice = gameData.ice;
                     const char = gameData.character || {};
                     const missions = gameData.missions || [];
                     
                     const rubricText = (ice.rubricMatrix || []).map(r => "- [" + r.category + "] I: " + r.i_text + ", C: " + r.c_text + ", E: " + r.e_text).join('\n');
                     const missionText = missions.map((m, i) => "フェーズ" + (i+1) + " [" + m.iceLevel + "]: " + m.name + " - SOS: " + m.characterSOS + " ").join('\n');
                     
                     sysPrompt = "あなたは「" + (char.name || 'キャラクター') + "」です。\\n" +
                                 "性格: " + (char.personality || '好奇心旺盛') + "\\n" +
                                 "場所: " + (char.location || '学校') + "\\n\\n" +
                                 "学習目標:\\n" +
                                 "I(基礎): " + ice.ideas.q + "\\n" +
                                 "C(関連): " + ice.connections.q + "\\n" +
                                 "E(応用): " + ice.extensions.q + "\\n\\n" +
                                 "ミッション構成:\\n" + missionText + "\\n\\n" +
                                 "ルーブリック:\\n" + rubricText + "\\n\\n" +
                                 "【重要】必ず50文字以内で返答してください。キャラクターの口調を維持し、以下のステップで会話を進めてください。\\n" +
                                 "1. まず、自分が直面している問題を「助けを求める言葉（SOS）」として伝えてください。\\n" +
                                 "2. 次に、ユーザーに対して「I（基礎知識）」について確認する質問を投げかけてください。\\n" +
                                 "3. その後、ユーザーの回答に応じて C→E の順で学習を進めてください。\\n" +
                                 "Eレベルまで到達したら[[END]] を付けてください。";
                }
                
                // AUTO-END INSTRUCTION
                sysPrompt += "\\n\\n[システム指示]\\n・会話が終わる場合以外は、必ず最後に「質問」または「回答を促す言葉」で終えてください。\\n・複数の吹き出しに分けたい場合は、文中に ||| という記号を入れて区切ってください。\\n・会話が完了したら返答の最後に [[END]] を付けてください。";

                // Append chat history for context
                const historyText = chatHistory.map(m => (m.sender === 'me' ? '助言者: ' : 'キャラクター: ') + m.text).join('\n');

                const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/" + model + ":generateContent?key=" + key, {
            method: 'POST',
                headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        contents: [
            { role: "user", parts: [{ text: sysPrompt + "\n\n[会話履歴]\n" + historyText + "\n\nキャラクター（50文字以内で返答）:" }] }
        ],
        generationConfig: {
            maxOutputTokens: 8192
        }
    })
});
const data = await response.json();
if (data.error) {
    throw new Error(data.error.message || "API Error");
}

if (!data.candidates || data.candidates.length === 0) {
    if (data.promptFeedback) {
        throw new Error("Blocked by Prompt Feedback: " + JSON.stringify(data.promptFeedback));
    }
    throw new Error("No candidates returned. Response: " + JSON.stringify(data));
}

const candidate = data.candidates[0];
// Allow MAX_TOKENS for chat, as partial text is better than error
if (candidate.finishReason && candidate.finishReason !== "STOP" && candidate.finishReason !== "MAX_TOKENS") {
    throw new Error("Generation stopped. Reason: " + candidate.finishReason);
}

let rawText = candidate.content?.parts?.[0]?.text;
if (!rawText) {
    throw new Error("No text in response. Candidate: " + JSON.stringify(candidate));
}

// CHECK FOR END SIGNAL
if (rawText.includes('[[END]]')) {
    shouldExit = true;
    rawText = rawText.replace('[[END]]', '').trim();
}
replyText = rawText;

            } catch (e) {
    console.error(e);
    replyText = "Error: " + e.message;
}
        }
    }

// Add Reply (Multi-Bubble Support)
const messages = replyText.split('|||').map(t => t.trim()).filter(t => t);

// Function to add messages sequentially
const addMessagesSequentially = (index) => {
    if (index >= messages.length) {
        // All messages added, check for exit
        if (shouldExit) {
            setTimeout(() => {
                if (node.chatMode === 'ai' && node.passNext) {
                    // Skip evaluation here, go to Ending first
                    triggerNext(node.passNext);
                } else {
                    triggerNext(node.next);
                }
            }, 2000);
        }
        return;
    }

    chatHistory.push({ sender: 'them', text: messages[index] });
    render(); // Re-render chat view

    // Scroll to bottom
    const chatContainer = document.getElementById('chat-messages');
    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;

    // Schedule next message
    setTimeout(() => addMessagesSequentially(index + 1), 1000);
};

// Start adding messages with initial delay
setTimeout(() => addMessagesSequentially(0), 1000);
} catch(e) { alert("Error: " + e.message); }
}

// AIによるチャット評価処理 (学びの評価に基づく)
async function evaluateChat(node, nextIdOverride) {
    const loading = document.getElementById('chat-loading');
    // If not in chat view, we might need a global loading overlay or just use the one if available
    // For now, let's assume we can find it or create a temporary one
    if (loading) {
        loading.classList.remove('hidden');
        loading.innerHTML = '<div class="bg-white p-4 rounded shadow-lg text-xs font-bold flex items-center gap-2"><div class="w-4 h-4 border-2 border-blue-500 rounded-full animate-spin border-t-transparent"></div>AI評価中...</div>';
    } else {
        // Create overlay if missing (e.g. called from Ending screen)
        const overlay = document.createElement('div');
        overlay.id = 'temp-loading';
        overlay.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center text-white font-bold';
        overlay.innerHTML = '<div class="flex flex-col items-center gap-4"><div class="w-8 h-8 border-4 border-blue-500 rounded-full animate-spin border-t-transparent"></div><div>AI評価中...</div></div>';
        document.body.appendChild(overlay);
    }

    let key = node.apiKey || gameData.globalApiKey;
    if (!key) {
        const userInputKey = document.getElementById('user-api-key');
        if (userInputKey) key = userInputKey.value;
    }

    try {
        const model = node.modelName || gameData.gameSettings?.geminiModel || 'gemini-2.5-flash';
        const ice = gameData.ice;
        // Build rubric details for evaluator
        const rubricDetails = (ice.rubricMatrix || []).map(r =>
        `Category: ${r.category} (Max Points: I=${r.i_score}, C=${r.c_score}, E=${r.e_score})
Criteria: I=${r.i_text}, C=${r.c_text}, E=${r.e_text}`
        ).join('\n\n');

        const historyText = (chatHistory || []).map(m => {
            const role = m.sender === 'me' ? 'Teacher' : 'Student';
            const content = m.text ? m.text.replace(/\`/g, "'") : '(empty)';
            return role + ': ' + content;
        }).join('\n');

console.log("Debug: History Length", chatHistory.length);
console.log("Debug: History Text", historyText);

if (!historyText) {
    console.warn("Chat history is empty during evaluation");
}

const evalPrompt = `
            以下の会話履歴と評価ルーブリックに基づいて、「先生（ユーザー）」のパフォーマンスを評価してください。
            
            [会話履歴]
            ${historyText || '(会話履歴なし)'}

            [評価ルーブリック]
            ${rubricDetails}

            以下の構造を持つJSONオブジェクトのみを出力してください（マークダウンは不要です）。
            必ず日本語で出力してください。
            {
                "totalScore": 数値 (0-100),
                "reason": "評価の要約（日本語）",
                "feedback": {
                    "good": "良かった点（日本語で具体的に）",
                    "improvement": "改善点とアドバイス（日本語で具体的に）"
                },
                "details": {
                    "CategoryName1": { "I": score, "C": score, "E": score },
                    "CategoryName2": { "I": score, "C": score, "E": score }
                }
            }
        `;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [
                    { role: "user", parts: [{ text: evalPrompt }] }
                ],
                generationConfig: {
                    maxOutputTokens: 8192
                }
            })
        });
        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        
        // Parse JSON (handle potential markdown fences)
        const jsonStr = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
        const result = JSON.parse(jsonStr);

        // --- SCORING RE-CALCULATION (Avoid AI Math Errors and Over-Scoring) ---
        // AIが返した合計点(totalScore)は信頼せず、個別の詳細スコアを積み上げて再計算する。
        // また、設定された最大点数を超えないようにクランプ処理を行う。
        
        // Initialize re-calculated score
        let calculatedTotalScore = 0;
        
        // Ensure structure exists
        if(!result.details) result.details = {};

        // Rubric Matrixに基づいて正確に計算
        // ICEモデルの評価ロジック:
        // 各カテゴリごとに I(Ideas/基礎), C(Connections/関連), E(Extensions/応用) の3つの観点で評価する。
        // それぞれに配点があり(デフォルト10点ずつなど)、それらの合計がカテゴリのスコアとなる。
        // 全カテゴリのスコアの合計が、ゲーム全体の総合評価(Total Score)となる。
        (gameData.ice.rubricMatrix || []).forEach(row => {
            const cat = row.category;
            const maxI = parseInt(row.i_score) || 0;
            const maxC = parseInt(row.c_score) || 0;
            const maxE = parseInt(row.e_score) || 0;

            // Get AI scores (default to 0 if missing)
            let detail = result.details[cat] || { I: 0, C: 0, E: 0 };
            
            // Clamp scores (AIが最大点より大きい値を返した場合の補正)
            let scoreI = Math.min(detail.I || 0, maxI);
            let scoreC = Math.min(detail.C || 0, maxC);
            let scoreE = Math.min(detail.E || 0, maxE);

            // Update result object with corrected values
            if(!result.details[cat]) result.details[cat] = {};
            // Ensure integer
            result.details[cat].I = scoreI;
            result.details[cat].C = scoreC;
            result.details[cat].E = scoreE;

            // Add to total
            calculatedTotalScore += (scoreI + scoreC + scoreE);
        });

        // Apply calculated score
        gameScore = calculatedTotalScore;
        result.totalScore = calculatedTotalScore; // Sync AI result with reality
        scoreDetails = result;

        console.log("Calculated Score:", gameScore);

        // Determine route
        const threshold = parseInt(node.scoreThreshold) || 60;
        const nextId = nextIdOverride || (gameScore >= threshold ? node.passNext : node.failNext);
        
        // Update the target node's isGood status based on score
        const targetNode = gameData.nodes.find(n => n.id === nextId);
        if(targetNode && targetNode.type === 'result') {
            targetNode.isGood = gameScore >= threshold;
        }

        triggerNext(nextId);

    } catch(e) {
        console.error("Evaluation failed", e);
        alert("採点エラーが発生しました。次に進みます。");
        triggerNext(nextIdOverride || node.next); // Fallback
    } finally {
        if(loading) loading.classList.add('hidden');
        const tempOverlay = document.getElementById('temp-loading');
        if(tempOverlay) tempOverlay.remove();
    }
}

window.gameTrigger = function(id) { triggerNext(id); };

// Start
window.onload = render;

    </script>
</body>
</html>